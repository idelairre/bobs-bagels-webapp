var menu=function(a){var b=function(a,b){var c=[];a.ingredients.forEach(function(a){c.push(a.id)}),a.extras=$.grep(b.ingredients,function(a){return _.contains(c,a.id)===!1?a.id:void 0})};return renderBagels=function(a,b){8===a.id?a.bagel=b.bagels[3]:9===b.id?a.bagel=b.bagels[1]:10===a.id?a.bagel=b.bagels[2]:12===a.id?a.bagel=b.bagels[4]:a.bagel=b.bagels[0],a.otherBagels=$.grep(b.bagels,function(b){return b.id!=a.bagel.id})},a.renderBagelMenu=function(a,c){a.forEach(function(a){a.price=accounting.formatMoney(a.price),b(a,c),renderBagels(a,c)});var d=Handlebars.compile($("#menu-info").html());$("#content").html(d({products:a}))},a.prettifyOrderPrices=function(a){a.extras=accounting.formatMoney(a.extras),a.delivery_cost=accounting.formatMoney(a.delivery_cost),a.taxes=accounting.formatMoney(a.taxes),a.subtotal=accounting.formatMoney(a.subtotal),a.total=accounting.formatMoney(a.total)},a.renderDrinks=function(a){a.forEach(function(a){a.price=accounting.formatMoney(a.price)});var b=Handlebars.compile($("#drink-render").html());$("#content").append(b({drinks:a}))},a.renderCaterMenu=function(a){a=$.grep(a,function(a){return"c"==a.product_type}),a.forEach(renderBagels);var b=Handlebars.compile($("#cater-menu").html());$("#content").html(b({products:a}))},a}(menu||{}),router=function(a){a.host="http://bobs-bagels-api.herokuapp.com",a.normalizeNav=function(){void 0==localStorage.authToken?$(".signed-in").hide():$(".signed-out").hide()};var b=Backbone.Router.extend({routes:{"":"home",home:"home",payments:"payments","delivery-options":"deliveryOptions",registration:"registration","detailed-cart":"detailedCart",login:"login",catering:"catering","my-profile":"myProfile","preorder-summary":"preorderSummary","order-history":"orderHistory",about:"about",logout:"logout","user-payments":"userPayments",cart:"cart"},home:function(){$("#content").empty(),$.ajax({url:a.host+"/products",type:"GET"}).done(aLaCart.init).fail(),cart.init()},payments:function(){$("#content").empty().load("partials/payment-form.html"),order.init()},preorderSummary:function(){$("#content").empty().load("partials/preorder-summary.html")},deliveryOptions:function(){$("#content").empty().load("partials/order-time-form.html"),order.init()},detailedCart:function(){$("#content").empty().load("partials/detailed-cart.html"),cart.renderDetailedCart(),cart.init},logout:function(){localStorage.removeItem("authToken"),$("#content").empty().load("partials/logged_out.html"),$(".signed-in").hide(),$(".signed-out").show()},registration:function(){$("#content").empty().load("partials/registration-form.html"),registration.init()},orderHistory:function(){profile.getOrders()},login:function(){$("#content").empty().load("partials/login-form.html"),registration.init()},cart:function(){cart.renderDetailedCart(),cart.init()},catering:function(){$("#content").empty(),$.ajax({url:a.host+"/products",type:"GET"}).done(catering.init).fail(),cart.init()},userPayments:function(){cart.renderDetailedCart(),cart.init(),order.init()},myProfile:function(){$("#content").empty(),profile.init()},about:function(){$("#content").empty().load("partials/about.html")}});return a.router=new b,a.backbone=function(){Backbone.history.start()},a}(router||{});$(document).ready(function(){router.backbone(),router.normalizeNav()});var payment=function(a){return a.paymentType=function(){void 0==localStorage.customerId||"undefined"==localStorage.customerId||null==localStorage.customerId?location.href="/#/payments":location.href="/#/user-payments"},a.cardPay=function(){Stripe.card.createToken({number:$("#number").val(),cvc:$("#cvc").val(),exp_month:$("#exp-month").val(),exp_year:$("#exp-year").val()},_stripeResponseHandler)},_stripeResponseHandler=function(a,b){console.log(b);var c=$("#payment-form");if(b.error)c.find(".payment-errors").text(b.error.message),c.find("button").prop("disabled",!1);else{var d=b.id;order.submitOrder(d)}},a.checkStatus=function(){return"checked"==$('input[name="store-payment-info"]:checked').attr("checked")?!0:!1},a}(payment||{}),cart=function(a){var b=function(a){var b={},c=a.attr("id"),d=JSON.parse(localStorage.count);return d+=1,b.product_id=c,b.quantity=parseInt($("#"+c+"quantity").val()),b.name=$("#"+c+"name").text(),b.comments=$("#"+c+"comments").val(),b.price=$("#"+c+"price").text(),b.id=d,b.description=$("#"+c+"description").text(),b.ingredients=$("form#"+c+" input[type=checkbox]:checked").map(function(){return this.value}).get(),b.bagel=$("form#"+c+" input:radio[name=bagel]:checked").val(),localStorage.count=JSON.stringify(d),b};renderNavCart=function(){var a=JSON.parse(localStorage.cart);a=cart.calcCart(a),a.total=accounting.formatMoney(a.total);var b=Handlebars.compile($("#cart-render").html());$("#cart").html(b({cart:a}))},a.cartIngredientRender=function(a,b){var c=$.grep(b.ingredients,function(b){return a.ingredients.indexOf(b.id.toString())>-1});a.ingredients=c},a.renderDetailedCart=function(){var a=JSON.parse(localStorage.cart);if(a.length<1)$("#content").html("<h3>You haven't added anything to your cart yet. Get shopping you cheapskate!</h3>");else{a.forEach(function(a){cart.cartIngredientRender(a,aLaCart)});var b=Handlebars.compile($("#detailed-cart-render").html());$("#content").html(b({orderItem:a}))}};var c=function(a){return Number(a.substring(1,a.length))},d=function(a){return c(a.price)*a.quantity};a.cartReset=function(){localStorage.removeItem("cart"),localStorage.setItem("cart","[]"),renderNavCart()},a.calcCart=function(a){var b={total:0,quantity:0};return a.forEach(function(a){b.total=b.total+d(a),b.quantity=b.quantity+a.quantity}),b};var e=function(){void 0===localStorage.cart&&localStorage.setItem("cart","[]"),void 0===localStorage.count&&localStorage.setItem("count","0")},f=function(a){var c=b(a),d=JSON.parse(localStorage.cart);d.push(c),localStorage.setItem("cart",JSON.stringify(d)),renderNavCart()},g=function(a){var b=JSON.parse(localStorage.cart);b=$.grep(b,function(b){return b.id!=a.val()}),localStorage.setItem("cart",JSON.stringify(b)),renderNavCart(),cart.renderDetailedCart()};return a.preorderCalcCart=function(){var a=["02210","02108","02109","02110","02111","02113","02203"],b=JSON.parse(localStorage.cart);if(a.indexOf(localStorage.zipcode)>-1)var c=10;else var c=6;var d=cart.calcCart(b).total+c,e=.07*(d+c),f=d+e,g=accounting.formatMoney(e),h=accounting.formatMoney(f),i=accounting.formatMoney(d),j=accounting.formatMoney(c);cart.renderPreorderSummary(g,h,i,j)},a.renderPreorderSummary=function(a,b,c,d){var e=JSON.parse(localStorage.cart);console.log(e);var f=Handlebars.compile($("#preorder-summary-render").html());$("#content").html(f({cart:e,taxes:a,deliveryCost:d,subtotal:c,total:b}))},a.init=function(){$("#content").off().on("submit",".menu-form",function(a){a.preventDefault(),f($(this))}),$("#content").on("click",".remove-cart",function(a){a.preventDefault(),g($(this))}),$("#nav-item").on("click","a.detailed-cart",function(a){console.log("clicked"),$("#content").empty()}),e(),renderNavCart()},a}(cart||{}),order=function(a){a.zips=["02210","02108","02109","02110","02111","02113","02203","02114","02115","02116","02134","02135","02138","02139","02140","02141","02142","02143","02144","02145","02446"];var b=function(){var a=$("#date-time-form"),b=/\(?([0-9]{3})\)?([ .-]?)([0-9]{3})\2([0-9]{4})/,c=/^\s*\S+(?:\s+\S+){2}/;"delivery"==$("input:radio[name=delivery-option]:checked").val()?order.zips.indexOf($("#zipcode").val())>-1?b.test($("#phone-number").val())?c.test($("#street-1").val())?d():a.find(".delivery-errors").text("You must enter a valid address."):a.find(".delivery-errors").text("You must enter a valid phone number."):a.find(".delivery-errors").text("You must be desperate for bagels. We don't deliver that far!"):d()},c=function(){localStorage.deliveryMethod=$("input:radio[name=delivery-option]:checked").val(),localStorage.orderTime=$("#time").val(),localStorage.zipcode=$("#zipcode").val(),localStorage.streetOne=$("#street-1").val(),localStorage.streetTwo=$("#street-2").val(),localStorage.phoneNumber=$("#phone-number").val(),payment.paymentType()},d=function(){var a=$("#date-time-form");void 0==localStorage.authToken||"undefined"==localStorage.authToken?a.find(".delivery-errors").text("You must be logged in to make a purchase"):e()},e=function(){localStorage.cart.length<3?location.href="/#/cart":c()};return a.submitOrder=function(a){$.ajaxPrefilter(function(a){a.headers={},a.headers.AUTHORIZATION="Token token="+localStorage.authToken});var b=payment.checkStatus();$.ajax({url:"http://bobs-bagels-api.herokuapp.com/users/"+localStorage.authToken+"/orders",type:"POST",data:{order:{delivery_type:localStorage.deliveryMethod,delivery_address_1:localStorage.streetOne,delivery_address_zipcode:localStorage.zipcode,delivery_address_2:localStorage.streetTwo,delivery_phone:localStorage.phoneNumber,cart:localStorage.cart,store_info:b,token:a,customer_id:localStorage.customerId}}}).done(function(a){cart.cartReset(),renderOrderSummary(a),getCustomerId()}).fail(function(a,b,c){console.log(a,b,c)})},getCustomerId=function(){$.ajax({url:"http://bobs-bagels-api.herokuapp.com/users/"+localStorage.authToken,type:"GET",dataType:"JSON"}).done(function(a){localStorage.setItem("customerId",a[0].customer_id)})},renderOrderSummary=function(a){menu.prettifyOrderPrices(a.data);var b=JSON.parse(a.data.cart);b.forEach("delivery"==a.data.type||"pickup"==a.data.type?function(a){cart.cartIngredientRender(a,aLaCart),console.log()}:function(a){cart.cartIngredientRender(a,catering)});var c=Handlebars.compile($("#order-summary-render").html());$("#content").html(c({items:b,order:a}))},a.init=function(){$("#content").on("click","#delivery",function(){$("#delivery-add").empty().load("partials/delivery-address-form.html")}),$("#content").on("click","#pickup",function(){$("#delivery-add").empty()}),$("#content").on("click","#delivery-submit",function(a){b(),console.log("clicked")}),$("#content").on("click","#confirm",function(a){}),$("#content").on("click","#checkout",function(a){$("#content").empty(),console.log("checkout button clicked"),cart.preorderCalcCart()}),$("#content").unbind("submit").bind("submit","#payment-form",function(a){a.preventDefault(),console.log("also clicked"),payment.cardPay()}),$("#content").on("click","#user-pay",function(a){a.preventDefault(),console.log("also clicked"),order.submitOrder()}),$("#content").on("click","#decline",function(a){a.preventDefault(),console.log("also clicked"),location.href="/#/payments"})},a}(order||{}),registration=function(a){var b;return a.submitRegistration=function(){return $.ajax({url:"http://bobs-bagels-api.herokuapp.com/users",type:"POST",data:{user:{first_name:$("#first-name").val(),last_name:$("#last-name").val(),email:$("#email").val(),phone_number:$("#phone_number").val(),address_1:$("#address_1").val(),address_2:$("#address_2").val(),address_zipcode:$("#address_zipcode").val(),password:$("#password").val()}}}).done(registration.loginSuccess).fail(registration.acceptFailure),!1},a.loginSuccess=function(a){localStorage.setItem("authToken",a.token),console.log("logged in!"),window.location.href="#/home",$(".signed-in").show(),$(".signed-out").hide()},a.submitLogin=function(a){return $.ajax({url:"http://bobs-bagels-api.herokuapp.com/users/sign_in",type:"POST",data:{email:$("#email").val(),password:$("#password").val()}}).done(registration.loginSuccess).fail(registration.acceptFailure),!1},a.setupAjaxRequests=function(){$.ajaxPrefilter(function(a){a.headers={},a.headers.AUTHORIZATION="Token token="+b})},a.acceptFailure=function(a){401===a.status&&(console.log("SEND TO LOGIN SCREEN"),window.location.href="#/registration")},a.init=function(){console.log("yo in the registration"),b=localStorage.getItem("authToken"),registration.setupAjaxRequests(),$("#content").on("click","#registration-submit",function(a){a.preventDefault(),registration.submitRegistration()}),$("#content").on("submit","#login-form",function(a){a.preventDefault(),registration.submitLogin()})},a}(registration||{}),aLaCart=function(a){return a.ingredients=[{id:1,name:"tomato",price:"0.0"},{id:2,name:"cucumber",price:"0.0"},{id:3,name:"red onions",price:"0.0"},{id:4,name:"cole slaw",price:"0.0"},{id:5,name:"mayo",price:"0.5"},{id:6,name:"garlic mayo",price:"0.5"},{id:7,name:"mustard",price:"0.5"},{id:8,name:"spicy mustard",price:"0.5"},{id:9,name:"plain cream cheese",price:"1.5"},{id:10,name:"chive cream cheese",price:"1.5"},{id:11,name:"tofutti",price:"2.0"},{id:12,name:"salmon spread",price:"2.5"},{id:13,name:"asiago",price:"0.5"},{id:14,name:"provolone",price:"0.5"},{id:15,name:"swiss",price:"0.5"},{id:16,name:"cheddar cheese",price:"0.5"},{id:17,name:"avocado",price:"2.0"},{id:18,name:"sprouts",price:"0.5"},{id:19,name:"turkey",price:"2.0"},{id:20,name:"smoked salmon",price:"3.5"},{id:21,name:"roast beef",price:"2.0"},{id:22,name:"corn beef",price:"3.0"}],a.bagels=[{id:1,bagel_type:"plain",price:"0.0"},{id:2,bagel_type:"onion",price:"0.5"},{id:3,bagel_type:"sesame seed",price:"0.5"},{id:4,bagel_type:"whole wheat",price:"0.5"},{id:5,bagel_type:"poppyseed",price:"0.5"},{id:6,bagel_type:"cinnamon raison",price:"0.5"}],a.init=function(a){var b=$.grep(a,function(a){return"a"===a.product_type||"b"===a.product_type}),c=$.grep(a,function(a){return"d"===a.product_type});menu.renderBagelMenu(b,aLaCart),menu.renderDrinks(c)},a}(aLaCart||{}),catering=function(a){return a.ingredients=[{id:23,name:"plain cream cheese",price:"0.00"},{id:24,name:"chive cream cheese",price:"4.00"},{id:25,name:"tofutti cream cheese",price:"4.50"},{id:26,name:"salmon spread",price:"5.50"}],a.bagels=[{id:1,bagel_type:"plain",price:"0.0"},{id:7,bagel_type:"onion",price:"2.0"},{id:8,bagel_type:"sesame seed",price:"2.0"},{id:9,bagel_type:"whole wheat",price:"2.0"},{id:10,bagel_type:"poppyseed",price:"2.0"},{id:11,bagel_type:"cinnamon raison",price:"2.0"},{id:12,bagel_type:"variety pack (all the bagels!)",price:"3.0"}],a.init=function(a){var b=$.grep(a,function(a){return"c"===a.product_type}),c=$.grep(a,function(a){return"d"===a.product_type});menu.renderBagelMenu(b,catering),menu.renderDrinks(c)},a}(catering||{}),profile=function(a){return a.handleForm=function(a){console.log("inside handleForm, user id is: "+a),$("#edit-profile-submit").on("click",function(b){b.preventDefault(),console.log("Clicked Save Profile button, user id is: "+a),profile.getAjax(a)}),$("#edit-profile-cancel").on("click",function(b){b.preventDefault(),console.log("Clicked Cancel button, user id is: "+a),$("#edit-profile-form").hide()})},a.getOrders=function(a){$.ajax({url:"http://bobs-bagels-api.herokuapp.com/users/"+localStorage.authToken,type:"GET",dataType:"JSON"}).done(indexOrderHistory).fail(function(a,b,c){console.log(a,b,c)})},indexOrderHistory=function(a){a[0].orders.length<1?$("#content").html("<h2>You haven't made any orders yet.You don't know what you're missing!</h2>"):renderOrderHistory(a)},makeDatePretty=function(a){return new Date(Date.parse(a.replace(/( +)/," UTC$1")))},renderOrderHistory=function(a){a[0].orders.forEach(function(a){menu.prettifyOrderPrices(a),a.created_at=makeDatePretty(a.created_at),a.cart=JSON.parse(a.cart),a.cart.forEach("delivery"==a.type||"pickup"==a.type?function(a){a.price=accounting.formatMoney(a.price),cart.cartIngredientRender(a,aLaCart)}:function(a){a.price=accounting.formatMoney(a.price),cart.cartIngredientRender(a,catering)})});var b=Handlebars.compile($("#order-history-render").html());$("#content").html(b({orderHistory:a}))},a.getAjax=function(a){$.ajax({url:"http://bobs-bagels-api.herokuapp.com/users/"+a,type:"PATCH",dataType:"JSON",data:{user:{first_name:$("#user-first-name-field").val(),last_name:$("#user-last-name-field").val(),email:$("#user-email-field").val(),phone_number:$("#user-phone-field").val(),address_1:$("#user-address-1-field").val(),address_2:$("#user-address-2-field").val(),address_zipcode:$("#user-zipcode-field").val()}}}).done(function(a){console.log(a),profile.init()}).fail(function(a,b,c){console.log(a,b,c)})},a.init=function(){$.ajax({url:"http://bobs-bagels-api.herokuapp.com/users/"+localStorage.authToken,type:"GET",dataType:"JSON"}).done(function(a){console.log(a);var b=Handlebars.compile($("#user_profile_template").html());$("#content").html(b({user:a})),$("#edit-profile-form").hide(),$(".edit-profile").on("click",function(a){var b=$(this).attr("id").replace("edit-profile-b-","");console.log("EDIT PROFILE clicked, user id is: "+b),$("#edit-profile-form").toggle(),profile.handleForm(b)})}).fail(function(a,b,c){console.log(a,b,c)}),profile.getCustomerInfo()},a.renderUserPaymentInfo=function(a){var b=JSON.stringify(a);a=b.replace(/\s/g,"_"),a=JSON.parse(b);var c=a.data,d=Handlebars.compile($("#user-pay-render").html());$("#content").append(d({data:c,id:c.id,name:c.name,address_city:c.address_city,address_country:c.address_country,address_line1:c.address_line1,address_line2:c.address_line2,address_zip:c.address_zip,brand:c.brand,exp_month:c.exp_month,exp_year:c.exp_year,type:c.funding,last4:c.last4}))},a.getCustomerInfo=function(){$.ajax({url:"http://bobs-bagels-api.herokuapp.com/users/retrieve_card",type:"POST",data:{user:{token:localStorage.authToken}}}).done(function(a){console.log(a),profile.renderUserPaymentInfo(a)}).fail(function(a,b,c){console.log(a,b,c)})},a}(profile||{});